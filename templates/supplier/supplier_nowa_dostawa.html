{% extends "supplier/supplier_base.html" %} {% block title %}Nowa Dostawa{%
endblock %} {% block supplier_content %}
<div class="mx-auto max-w-screen-xl px-4 lg:px-12">
    <!-- Stepper -->
    <ol class="flex items-center w-full mb-4 sm:mb-5">
    <li
      class="flex w-full items-center after:content-[''] after:w-full after:h-1 after:border-b after:border-gray-100 after:border-4 after:inline-block dark:after:border-gray-700"
    >
      <div
        class="flex items-center justify-center w-10 h-10 bg-violet-500/10 rounded-full lg:h-12 lg:w-12 dark:bg-violet-500/20 shrink-0"
      >
        <svg
          class="w-4 h-4 text-violet-500 lg:w-6 lg:h-6 dark:text-violet-500/80"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="currentColor"
          viewBox="0 0 20 16"
        >
          <path
            d="M18 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2ZM6.5 3a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5ZM3.014 13.021l.157-.625A3.427 3.427 0 0 1 6.5 9.571a3.426 3.426 0 0 1 3.322 2.805l.159.622-6.967.023ZM16 12h-3a1 1 0 0 1 0-2h3a1 1 0 0 1 0 2Zm0-3h-3a1 1 0 1 1 0-2h3a1 1 0 1 1 0 2Zm0-3h-3a1 1 0 1 1 0-2h3a1 1 0 1 1 0 2Z"
          />
                </svg>
            </div>
        </li>
    <li
      class="flex w-full items-center after:content-[''] after:w-full after:h-1 after:border-b after:border-gray-100 after:border-4 after:inline-block dark:after:border-gray-700"
    >
      <div
        class="flex items-center justify-center w-10 h-10 bg-gray-100/80 rounded-full lg:h-12 lg:w-12 dark:bg-gray-800/50 shrink-0"
      >
        <svg
          class="w-4 h-4 text-violet-500/70 lg:w-6 lg:h-6 dark:text-violet-500/50"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="currentColor"
          viewBox="0 0 20 14"
        >
          <path
            d="M18 0H2a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2ZM2 12V6h16v6H2Z"
          />
          <path
            d="M6 8H4a1 1 0 0 0 0 2h2a1 1 0 0 0 0-2Zm8 0H9a1 1 0 0 0 0 2h5a1 1 0 1 0 0-2Z"
          />
                </svg>
            </div>
        </li>
    <li
      class="flex w-full items-center after:content-[''] after:w-full after:h-1 after:border-b after:border-gray-100 after:border-4 after:inline-block dark:after:border-gray-700"
    >
      <div
        class="flex items-center justify-center w-10 h-10 bg-gray-100 rounded-full lg:h-12 lg:w-12 dark:bg-gray-700 shrink-0"
      >
        <svg
          class="w-4 h-4 text-purple-600 lg:w-6 lg:h-6 dark:text-purple-300"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="currentColor"
          viewBox="0 0 20 16"
        >
          <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"
          />
                </svg>
            </div>
        </li>
        <li class="flex items-center">
      <div
        class="flex items-center justify-center w-10 h-10 bg-gray-100 rounded-full lg:h-12 lg:w-12 dark:bg-gray-700 shrink-0"
      >
        <svg
          class="w-4 h-4 text-purple-600 lg:w-6 lg:h-6 dark:text-purple-300"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"
          />
                </svg>
            </div>
        </li>
    </ol>

    <!-- Formularze dla poszczególnych kroków -->
  <div
    id="step1"
    class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-soft mb-6"
  >
    <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">
      Krok 1: Informacje podstawowe
    </h3>
        <form id="step1Form" class="space-y-4">
            <div class="grid gap-4 sm:grid-cols-2">
                <div>
          <label
            for="delivery_date"
            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
            >Data dostawy</label
          >
          <input
            type="date"
            name="delivery_date"
            id="delivery_date"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus-visible:ring-2 focus-visible:ring-violet-500 focus-visible:border-violet-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus-visible:ring-violet-500 dark:focus-visible:border-violet-500 transition duration-200 ease-out"
            required
          />
                </div>
                <div>
          <label
            for="delivery_category"
            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
            >Kategoria dostawy</label
          >
          <select
            id="delivery_category"
            name="delivery_category"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            required
          >
                        <option value="">Wybierz kategorię</option>
                        <option value="MIX">MIX</option>
                        <option value="Elektronika">Elektronika</option>
                        <option value="AGD">AGD</option>
                        <option value="Meble">Meble</option>
                        <option value="Ogród">Ogród</option>
                        <option value="other">Inne</option>
                    </select>
                </div>
            </div>
            
            <div id="other_category_container" class="hidden">
        <label
          for="other_category"
          class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
          >Inna kategoria</label
        >
        <input
          type="text"
          name="other_category"
          id="other_category"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
          placeholder="Wpisz kategorię"
        />
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
                <div>
          <label
            for="product_class"
            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
            >Klasa Produktów</label
          >
          <select
            id="product_class"
            name="product_class"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            required
          >
                        <option value="">Wybierz klasę</option>
                        <option value="mix_abc">Mix ABC</option>
                        <option value="class_a">Klasa A</option>
                    </select>
                </div>
                <div>
          <label
            for="currency"
            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
            >Waluta</label
          >
          <select
            id="currency"
            name="currency"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            required
          >
                        <option value="">Wybierz walutę</option>
                        <option value="PLN">PLN</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
            </div>

            <div id="exchange_rate_container" class="hidden space-y-4">
        <label class="block text-sm font-medium text-gray-900 dark:text-white"
          >Kurs EUR</label
        >
        <input
          type="number"
          name="exchange_rate"
          id="exchange_rate"
          step="0.0001"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
          placeholder="Podaj kurs EUR"
        />
            </div>

            <div class="space-y-4">
        <label class="block text-sm font-medium text-gray-900 dark:text-white"
          >Wartość podatku VAT</label
        >
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
            <input
              type="radio"
              name="vat_rate"
              id="vat_23"
              value="23"
              class="w-4 h-4 text-violet-500 bg-gray-100 border-gray-300 focus:ring-2 focus:ring-violet-500/50 dark:focus-visible:ring-violet-500/30 dark:bg-gray-700 dark:border-gray-600"
              required
            />
            <label
              for="vat_23"
              class="ml-2 text-sm font-medium text-gray-900 dark:text-white"
              >23%</label
            >
                    </div>
                    <div class="flex items-center">
            <input
              type="radio"
              name="vat_rate"
              id="vat_0"
              value="0"
              class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
              required
            />
            <label
              for="vat_0"
              class="ml-2 text-sm font-medium text-gray-900 dark:text-white"
              >0%</label
            >
                    </div>
                </div>
            </div>

            <div id="price_type_container" class="hidden space-y-4">
        <label class="block text-sm font-medium text-gray-900 dark:text-white"
          >Ceny w specyfikacji są:</label
        >
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
            <input
              type="radio"
              name="price_type"
              id="price_net"
              value="net"
              class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
              required
            />
            <label
              for="price_net"
              class="ml-2 text-sm font-medium text-gray-900 dark:text-white"
              >Netto</label
            >
                    </div>
                    <div class="flex items-center">
            <input
              type="radio"
              name="price_type"
              id="price_gross"
              value="gross"
              class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
              required
            />
            <label
              for="price_gross"
              class="ml-2 text-sm font-medium text-gray-900 dark:text-white"
              >Brutto</label
            >
                    </div>
                </div>
            </div>

            <!-- Suwak procentowy -->
            <div class="space-y-2">
        <label
          for="value_percentage"
          class="block text-sm font-medium text-gray-900 dark:text-white"
        >
          Procent wartości:
          <span
            id="value_percentage_display"
            class="text-lg font-semibold text-gray-900 dark:text-white"
            >50</span
          >%
                </label>
        <input
          type="range"
          id="value_percentage"
          name="value_percentage"
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-purple-600"
          min="1"
          max="100"
          value="50"
          step="1"
          required
        />
        <div
          class="flex justify-between text-xs text-gray-600 dark:text-gray-400"
        >
                    <span>1%</span>
                    <span>100%</span>
                </div>
            </div>

            <div class="flex justify-end">
        <button
          type="button"
          id="step1NextButton"
          class="text-white bg-violet-500 hover:bg-violet-600 focus-visible:ring-4 focus-visible:ring-violet-500/50 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-violet-600 dark:hover:bg-violet-500 dark:focus-visible:ring-violet-500/30 transition duration-200 ease-out"
        >
                    Dalej
                </button>
            </div>
        </form>
    </div>

  <div
    id="step2"
    class="hidden bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6"
  >
    <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">
      Krok 2: Dokumenty
    </h3>
        <form id="step2Form" class="space-y-4">
            <div class="flex items-center justify-center w-full">
        <label
          for="dropzone-file"
          class="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 dark:hover:bg-gray-800/50 dark:bg-gray-700 transition duration-300 ease-out hover:border-brand dark:hover:border-brand dark:border-gray-600"
        >
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
            <svg
              class="w-8 h-8 mb-4 text-gray-500 dark:text-gray-400"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 20 16"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"
              />
                        </svg>
            <p class="mb-2 text-sm text-gray-500 dark:text-gray-400">
              <span class="font-semibold">Kliknij aby wgrać</span> lub
              przeciągnij i upuść
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-400">
              Obsługiwane formaty:
            </p>
                        <div class="flex flex-wrap justify-center gap-2 mt-2">
              <span
                class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded dark:bg-blue-900 dark:text-blue-300"
                >PDF</span
              >
              <span
                class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded dark:bg-green-900 dark:text-green-300"
                >XLSX</span
              >
              <span
                class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded dark:bg-green-900 dark:text-green-300"
                >XLS</span
              >
              <span
                class="px-2 py-1 text-xs font-medium bg-violet-100 text-purple-800 rounded dark:bg-violet-900 dark:text-purple-300"
                >DOC</span
              >
              <span
                class="px-2 py-1 text-xs font-medium bg-violet-100 text-purple-800 rounded dark:bg-violet-900 dark:text-purple-300"
                >DOCX</span
              >
              <span
                class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded dark:bg-yellow-900 dark:text-yellow-300"
                >CSV</span
              >
                        </div>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
              Maksymalny rozmiar: 10MB
            </p>
                    </div>
          <input
            id="dropzone-file"
            type="file"
            class="hidden"
            accept=".pdf,.doc,.docx,.xls,.xlsx,.csv"
            multiple
          />
                </label>
            </div>

            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
        <table
          class="w-full text-sm text-left text-gray-500 dark:text-gray-400"
        >
          <thead
            class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
          >
                        <tr>
                            <th scope="col" class="px-6 py-3">Nazwa pliku</th>
                            <th scope="col" class="px-6 py-3">Rozmiar</th>
                            <th scope="col" class="px-6 py-3">Typ</th>
                            <th scope="col" class="px-6 py-3 text-center">Status</th>
                            <th scope="col" class="px-6 py-3">Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="file-list">
                        <!-- Tu będą wyświetlane wgrane pliki -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between mt-6">
        <button
          type="button"
          id="step2PrevButton"
          class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg text-sm px-5 py-2.5 text-center dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700"
        >
                    Wstecz
                </button>
        <button
          type="button"
          id="step2NextButton"
          class="text-white bg-violet-500 hover:bg-violet-600 focus:ring-4 focus:outline-none focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-violet-600 dark:hover:bg-violet-500 dark:focus:ring-purple-800"
        >
                    Dalej
                </button>
            </div>
        </form>
    </div>

  <div
    id="step3"
    class="hidden bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6"
  >
    <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">
      Krok 3: Szczegóły dostawy
    </h3>
        <form id="step3Form" class="space-y-4">
            <!-- Sekcja podsumowania poprzednich kroków -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6">
        <h4 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
          Podsumowanie danych
        </h4>
                <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Numer Lotu</label>
            <input type="text" id="summary_lot_number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" readonly />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Numer Palety</label>
            <input type="text" id="summary_pallet_number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" readonly />
          </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data dostawy</label>
            <input type="date" id="summary_delivery_date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" />
                    </div>
                    <div>
            <label
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
              >Kategoria dostawy</label
            >
            <input
              type="text"
              id="summary_delivery_category"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            />
                    </div>
                    <div>
            <label
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
              >Klasa produktów</label
            >
            <input
              type="text"
              id="summary_product_class"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            />
                    </div>
                    <div>
            <label
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
              >Waluta</label
            >
            <input
              type="text"
              id="summary_currency"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            />
                    </div>
                    <div id="summary_exchange_rate_container">
            <label
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
              >Kurs EUR</label
            >
            <input
              type="number"
              id="summary_exchange_rate"
              step="0.0001"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            />
                    </div>
                    <div>
            <label
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
              >VAT</label
            >
            <input
              type="text"
              id="summary_vat"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            />
                    </div>
                    <div>
            <label
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
              >Typ cen</label
            >
            <input
              type="text"
              id="summary_price_type"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            />
                    </div>
                    <div>
            <label
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
              >Procent wartości</label
            >
            <input
              type="text"
              id="summary_value_percentage"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-600 focus:border-purple-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
              readonly
            />
                    </div>
                </div>
            </div>

      <!-- Pop-up dla brakujących danych -->
      <div id="missing_data_popup" data-modal-backdrop="static" tabindex="-1" class="fixed inset-0 bg-gray-900/50 dark:bg-gray-900/80 overflow-y-auto h-full w-full z-50 items-center justify-center invisible opacity-0 transition-all duration-300 ease-in-out flex">
        <div class="relative p-4 w-full max-w-md">
          <div class="relative bg-white rounded-lg shadow dark:bg-gray-800">
            <div class="p-4 md:p-5">
              <div class="flex items-center justify-center mb-4">
                <div class="inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-lg bg-yellow-100 text-yellow-500 dark:bg-yellow-800 dark:text-yellow-200">
                  <svg class="h-5 w-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM10 15a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm1-4a1 1 0 0 1-2 0V6a1 1 0 0 1 2 0v5Z"/>
                  </svg>
                    </div>
                    </div>
              <h3 class="mb-4 text-xl font-medium text-gray-900 dark:text-white text-center">Brakujące dane</h3>
              <form class="space-y-4">
                <div id="missing_lot_section" class="hidden">
                  <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Numer Lotu</label>
                  <input type="text" id="popup_lot_number" name="lot_number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Wprowadź numer lotu" required>
                </div>
                <div id="missing_pallet_section" class="hidden">
                  <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Numer Palety</label>
                  <input type="text" id="popup_pallet_number" name="pallet_number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Wprowadź numer palety" required>
                </div>
                <div class="flex justify-end space-x-3">
                  <button type="button" id="confirm_missing_data" class="text-white bg-violet-600 hover:bg-violet-700 focus:ring-4 focus:ring-violet-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-violet-600 dark:hover:bg-violet-700 focus:outline-none dark:focus:ring-violet-800">Potwierdź</button>
                  <button type="button" id="close_missing_data" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">Anuluj</button>
                </div>
              </form>
            </div>
          </div>
                </div>
            </div>

            <!-- Statystyki dostawy -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div
          class="bg-gradient-to-br from-violet-50 to-violet-100 dark:from-violet-900 dark:to-violet-800 p-6 rounded-xl shadow-soft border border-violet-200 dark:border-violet-700 transform hover:scale-[1.02] transition-all duration-200 ease-out"
        >
          <h5
            class="text-sm font-medium text-purple-600 dark:text-purple-300 mb-2"
          >
            Ilość Lotów w dostawie
          </h5>
          <p
            id="lots_count"
            class="text-3xl font-bold text-purple-700 dark:text-purple-200"
          >
            0
          </p>
                </div>
        <div
          class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900 dark:to-blue-800 p-4 rounded-lg shadow-lg border border-blue-200 dark:border-blue-700 transform hover:scale-105 transition-transform duration-200"
        >
          <h5 class="text-sm font-medium text-blue-600 dark:text-blue-300 mb-2">
            Ilość palet w dostawie
          </h5>
          <p
            id="pallets_count"
            class="text-3xl font-bold text-blue-700 dark:text-blue-200"
          >
            0
          </p>
                </div>
        <div
          class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900 dark:to-green-800 p-4 rounded-lg shadow-lg border border-green-200 dark:border-green-700 transform hover:scale-105 transition-transform duration-200"
        >
          <h5
            class="text-sm font-medium text-green-600 dark:text-green-300 mb-2"
          >
            Ilość produktów
          </h5>
          <p
            id="products_count"
            class="text-3xl font-bold text-green-700 dark:text-green-200"
          >
            0
          </p>
                </div>
        <div
          class="bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900 dark:to-amber-800 p-4 rounded-lg shadow-lg border border-amber-200 dark:border-amber-700 transform hover:scale-105 transition-transform duration-200"
        >
          <h5
            class="text-sm font-medium text-amber-600 dark:text-amber-300 mb-2"
          >
            Łączna wartość
          </h5>
          <p
            id="total_value"
            class="text-3xl font-bold text-amber-700 dark:text-amber-200"
          >
            0.00
          </p>
                </div>
            </div>

            <!-- Tabela produktów -->
            <div class="relative overflow-hidden shadow-soft sm:rounded-xl mb-4">
        <div
          class="max-h-[500px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600"
        >
          <table
            id="products-table"
            class="w-full text-sm text-left text-gray-500 dark:text-gray-400"
          >
            <thead
              class="text-xs text-gray-700 uppercase bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900 dark:to-purple-800 sticky top-0"
            >
                            <!-- Nagłówki będą dynamicznie aktualizowane -->
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Dane będą dynamicznie aktualizowane -->
                        </tbody>
                    </table>
                </div>
        <div
          class="bg-gradient-to-r from-gray-50 to-purple-50 dark:from-gray-800 dark:to-purple-900 sticky bottom-0"
        >
                    <div class="px-6 py-3 text-right">
            <span class="font-semibold text-purple-700 dark:text-purple-300"
              >Liczba pozycji:
            </span>
            <span
              id="items_count"
              class="text-lg font-bold text-purple-800 dark:text-purple-200"
              >0</span
            >
                    </div>
                </div>
            </div>

            <div class="flex justify-between mt-6">
        <button
          type="button"
          id="step3PrevButton"
          class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg text-sm px-5 py-2.5 text-center dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700"
        >
                    Wstecz
                </button>
        <button
          type="button"
          id="step3NextButton"
          class="text-white bg-violet-500 hover:bg-violet-600 focus:ring-4 focus:outline-none focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-violet-600 dark:hover:bg-violet-500 dark:focus:ring-purple-800"
        >
                    Dalej
                </button>
            </div>
        </form>
    </div>

  <div
    id="step4"
    class="hidden bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6"
  >
    <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">
      Krok 4: Podsumowanie
    </h3>
        <div class="space-y-4">
      <!-- Tabela podsumowująca -->
      <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
          <thead class="text-xs uppercase bg-gradient-to-r from-violet-500/10 to-violet-500/5 dark:from-violet-500/20 dark:to-violet-500/10">
            <tr>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Numer LOT</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Numery palet</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Kategoria dostawy</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Klasa produktów</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Ilość produktów</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Stawka VAT</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Procent wartości</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Wartość rynkowa ze specyfikacji</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Wartość rynkowa w PLN</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Cena za LOT BRUTTO PLN</th>
              <th scope="col" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200">Waluta</th>
              <th scope="col" id="exchange_rate_header" class="px-4 py-3 font-bold text-violet-900 dark:text-violet-200 hidden">Kurs EUR</th>
            </tr>
          </thead>
          <tbody>
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
              <td id="summary_table_lot" class="px-4 py-3"></td>
              <td id="summary_table_pallets" class="px-4 py-3"></td>
              <td id="summary_table_category" class="px-4 py-3"></td>
              <td id="summary_table_class" class="px-4 py-3"></td>
              <td id="summary_table_products" class="px-4 py-3"></td>
              <td id="summary_table_vat" class="px-4 py-3"></td>
              <td id="summary_table_percentage" class="px-4 py-3"></td>
              <td id="summary_table_market_value" class="px-4 py-3"></td>
              <td id="summary_table_market_value_pln" class="px-4 py-3"></td>
              <td id="summary_table_lot_price" class="px-4 py-3"></td>
              <td id="summary_table_currency" class="px-4 py-3"></td>
              <td id="summary_table_exchange_rate" class="px-4 py-3 hidden"></td>
            </tr>
          </tbody>
        </table>
                </div>

            <div class="flex justify-between mt-6">
        <button
          type="button"
          id="step4PrevButton"
          class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg text-sm px-5 py-2.5 text-center dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700"
        >
                    Wstecz
                </button>
        <button
          type="submit"
          form="deliveryForm"
          class="text-white bg-violet-500 hover:bg-violet-600 focus:ring-4 focus:outline-none focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-violet-600 dark:hover:bg-violet-500 dark:focus:ring-purple-800"
        >
                    Zatwierdź dostawę
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// Zmienne globalne
let currentStep = 1;
const totalSteps = 4;

// Funkcje nawigacji między krokami
function updateStepperUI(step) {
    document.querySelectorAll("ol.flex li div").forEach((div, index) => {
        if (index < step) {
        div.classList.remove("bg-gray-100/80", "dark:bg-gray-800/50");
        div.classList.add("bg-violet-500/10", "dark:bg-violet-500/20");
        } else {
        div.classList.remove("bg-violet-500/10", "dark:bg-violet-500/20");
        div.classList.add("bg-gray-100/80", "dark:bg-gray-800/50");
        }
    });
}

function showStep(step) {
    for (let i = 1; i <= totalSteps; i++) {
        const stepElement = document.getElementById(`step${i}`);
        if (stepElement) {
        stepElement.classList.add("hidden");
        }
    }
    const currentStepElement = document.getElementById(`step${step}`);
    if (currentStepElement) {
      currentStepElement.classList.remove("hidden");
        updateStepperUI(step);
    }
}

function validateStep(step) {
    const form = document.getElementById(`step${step}Form`);
    if (!form) return true;

    // Sprawdzenie wymaganych pól w kroku 1
    if (step === 1) {
        const requiredFields = [
        "delivery_date",
        "delivery_category",
        "product_class",
        "currency",
        ];

        // Sprawdź czy wszystkie wymagane pola są wypełnione
        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field || !field.value) {
                console.log(`Pole ${fieldId} jest wymagane`);
                return false;
            }
        }

        // Sprawdź czy pole kursu EUR jest wypełnione jeśli wybrano EUR
      const currency = document.getElementById("currency");
      const exchangeRate = document.getElementById("exchange_rate");
      if (currency.value === "EUR" && (!exchangeRate || !exchangeRate.value)) {
        console.log("Kurs EUR jest wymagany");
            return false;
        }

        // Sprawdź czy wybrano VAT
      const vatChecked = document.querySelector(
        'input[name="vat_rate"]:checked'
      );
        if (!vatChecked) {
        console.log("Wybór stawki VAT jest wymagany");
            return false;
        }

        // Sprawdź czy wybrano typ ceny jeśli VAT 23%
      const vat23 = document.getElementById("vat_23");
        if (vat23 && vat23.checked) {
        const priceTypeChecked = document.querySelector(
          'input[name="price_type"]:checked'
        );
            if (!priceTypeChecked) {
          console.log("Wybór typu ceny jest wymagany dla VAT 23%");
                return false;
            }
        }
    }

    return true;
}

function nextStep(step) {
    console.log("Próba przejścia do kroku:", step);
    console.log("Aktualny krok:", currentStep);
    
    if (validateStep(currentStep)) {
        console.log("Walidacja przeszła pomyślnie");
        
        // Najpierw pokazujemy następny krok
        currentStep = step;
        showStep(step);
        
        if (step === 3) {
            console.log("Przechodzę do kroku 3");
            updateStep3Summary();
            
            // Sprawdzamy czy brakuje danych po małym opóźnieniu
            setTimeout(() => {
                const lotNumber = document.getElementById("summary_lot_number").value;
                const palletNumber = document.getElementById("summary_pallet_number").value;
                
                console.log("Sprawdzam dane:");
                console.log("- Numer lotu:", lotNumber);
                console.log("- Numer palety:", palletNumber);
                
                const missingLotSection = document.getElementById("missing_lot_section");
                const missingPalletSection = document.getElementById("missing_pallet_section");
                const popup = document.getElementById("missing_data_popup");
                
                // Pokazujemy odpowiednie sekcje w pop-upie
                if (!lotNumber || lotNumber.trim() === "") {
                    console.log("Brak numeru lotu - pokazuję sekcję");
                    missingLotSection.classList.remove("hidden");
                } else {
                    missingLotSection.classList.add("hidden");
                }
                
                if (!palletNumber || palletNumber.trim() === "") {
                    console.log("Brak numeru palety - pokazuję sekcję");
                    missingPalletSection.classList.remove("hidden");
                } else {
                    missingPalletSection.classList.add("hidden");
                }
                
                // Pokazujemy pop-up tylko jeśli brakuje którejkolwiek z wartości
                if (!lotNumber || !palletNumber || lotNumber.trim() === "" || palletNumber.trim() === "") {
                    console.log("Pokazuję pop-up");
                    popup.classList.remove("invisible", "opacity-0");
                }
            }, 100);
        } else if (step === 4) {
            updateSummary();
        }
    } else {
        console.log("Walidacja nie przeszła");
        const form = document.getElementById(`step${currentStep}Form`);
        if (form) {
            form.reportValidity();
        }
    }
}

function prevStep(step) {
    currentStep = step;
    showStep(step);
}

function updateSummary() {
    // Pobierz wszystkie potrzebne wartości
    const lotNumber = document.getElementById("summary_lot_number").value;
    const palletNumber = document.getElementById("summary_pallet_number").value;
    const category = document.getElementById("summary_delivery_category").value;
    const productClass = document.getElementById("summary_product_class").value;
    const productsCount = document.getElementById("products_count").textContent;
    const vatRate = document.getElementById("summary_vat").value;
    const valuePercentage = document.getElementById("summary_value_percentage").value;
    const currency = document.getElementById("summary_currency").value;
    const exchangeRate = document.getElementById("summary_exchange_rate")?.value || 1;
    const priceType = document.getElementById("summary_price_type").value;
    
    // Pobierz wartość rynkową ze specyfikacji
    const marketValue = parseNumber(document.getElementById("total_value").textContent);
    
    // Oblicz wartość rynkową w PLN
    const marketValuePLN = currency === "EUR" ? marketValue * exchangeRate : marketValue;
    
    // Oblicz cenę za LOT BRUTTO PLN
    let lotPrice = marketValuePLN;
    if (priceType === "Netto" && vatRate === "23%") {
        lotPrice *= 1.23; // Dodaj VAT 23%
    }
    // Zastosuj procent wartości
    const percentageValue = parseFloat(valuePercentage) / 100;
    lotPrice *= percentageValue;

    // Aktualizuj tabelę podsumowującą
    document.getElementById("summary_table_lot").textContent = lotNumber;
    document.getElementById("summary_table_pallets").textContent = palletNumber;
    document.getElementById("summary_table_category").textContent = category;
    document.getElementById("summary_table_class").textContent = productClass;
    document.getElementById("summary_table_products").textContent = productsCount;
    document.getElementById("summary_table_vat").textContent = vatRate;
    document.getElementById("summary_table_percentage").textContent = valuePercentage;
    document.getElementById("summary_table_currency").textContent = currency;
    
    // Obsługa wyświetlania kursu EUR
    const exchangeRateHeader = document.getElementById("exchange_rate_header");
    const exchangeRateCell = document.getElementById("summary_table_exchange_rate");
    if (currency === "EUR") {
        exchangeRateHeader.classList.remove("hidden");
        exchangeRateCell.classList.remove("hidden");
        exchangeRateCell.textContent = exchangeRate;
    } else {
        exchangeRateHeader.classList.add("hidden");
        exchangeRateCell.classList.add("hidden");
    }
    
    // Formatuj wartości pieniężne
    document.getElementById("summary_table_market_value").textContent = new Intl.NumberFormat("pl-PL", {
        style: "currency",
        currency: currency
    }).format(marketValue);
    
    document.getElementById("summary_table_market_value_pln").textContent = new Intl.NumberFormat("pl-PL", {
        style: "currency",
        currency: "PLN"
    }).format(marketValuePLN);
    
    document.getElementById("summary_table_lot_price").textContent = new Intl.NumberFormat("pl-PL", {
        style: "currency",
        currency: "PLN"
    }).format(lotPrice);
}

function updateStep3Summary() {
    const deliveryDate = document.getElementById("delivery_date").value;
    const deliveryCategory = document.getElementById("delivery_category");
    const productClass = document.getElementById("product_class");
    const currency = document.getElementById("currency");
    const exchangeRateContainer = document.getElementById("summary_exchange_rate_container");
    
    document.getElementById("summary_delivery_date").value = deliveryDate;
    document.getElementById("summary_delivery_category").value =
        deliveryCategory.value === "other"
            ? document.getElementById("other_category").value
            : deliveryCategory.options[deliveryCategory.selectedIndex].text;
    document.getElementById("summary_product_class").value =
        productClass.options[productClass.selectedIndex].text;
    document.getElementById("summary_currency").value = currency.value;

    if (currency.value === "EUR") {
        const exchangeRate = document.getElementById("exchange_rate").value;
        document.getElementById("summary_exchange_rate").value = exchangeRate;
        exchangeRateContainer.classList.remove("hidden");
    } else {
        exchangeRateContainer.classList.add("hidden");
    }
    
    const vatRate = document.querySelector('input[name="vat_rate"]:checked');
    document.getElementById("summary_vat").value = vatRate ? `${vatRate.value}%` : "";
    
    const priceType = document.querySelector('input[name="price_type"]:checked');
    document.getElementById("summary_price_type").value = priceType
        ? priceType.value === "net" ? "Netto" : "Brutto"
        : "";

    document.getElementById("summary_value_percentage").value =
        `${document.getElementById("value_percentage").value}%`;
}

function toggleOtherCategory() {
    const category = document.getElementById("delivery_category");
    const otherContainer = document.getElementById("other_category_container");
    const otherInput = document.getElementById("other_category");

    if (category.value === "other") {
      otherContainer.classList.remove("hidden");
        otherInput.required = true;
    } else {
      otherContainer.classList.add("hidden");
        otherInput.required = false;
    }
}

function toggleExchangeRate() {
    console.log("Wywołano toggleExchangeRate");
    const currency = document.getElementById("currency");
    const rateContainer = document.getElementById("exchange_rate_container");
    const rateInput = document.getElementById("exchange_rate");
    const summaryContainer = document.getElementById(
      "summary_exchange_rate_container"
    );

    console.log("Wybrana waluta:", currency.value);

    if (currency.value === "EUR") {
      rateContainer.classList.remove("hidden");
        rateInput.required = true;
        if (summaryContainer) {
        summaryContainer.classList.remove("hidden");
        }
    } else {
      rateContainer.classList.add("hidden");
        rateInput.required = false;
      rateInput.value = "";
        if (summaryContainer) {
        summaryContainer.classList.add("hidden");
        }
    }
}

function togglePriceType() {
    console.log("Wywołano togglePriceType");
    const vat23Radio = document.getElementById("vat_23");
    const priceTypeContainer = document.getElementById("price_type_container");
    const priceTypeInputs = document.querySelectorAll(
      'input[name="price_type"]'
    );

    console.log("VAT 23% zaznaczony:", vat23Radio?.checked);
    
    if (vat23Radio && vat23Radio.checked) {
      priceTypeContainer.classList.remove("hidden");
      priceTypeInputs.forEach((input) => (input.required = true));
    } else {
      priceTypeContainer.classList.add("hidden");
      priceTypeInputs.forEach((input) => {
            input.required = false;
            input.checked = false;
        });
    }
}

// Funkcje pomocnicze
function formatFileSize(bytes) {
    if (bytes === 0) return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
}

function parseNumber(value) {
    if (!value || value === "") return 0;
    
    // Zamiana na string i usunięcie wszystkich białych znaków
    let str = String(value).trim();
    
    // Jeśli liczba jest zapisana w formacie naukowym (np. 1.23e+4)
    if (str.includes("e")) {
        return parseFloat(str) || 0;
    }
    
    // Usuwamy wszystkie znaki oprócz cyfr, kropek i przecinków
    str = str.replace(/[^\d.,\-]/g, "");
    
    // Jeśli po usunięciu niepotrzebnych znaków string jest pusty, zwróć 0
    if (!str) return 0;
    
    // Jeśli jest przecinek i kropka, zakładamy format polski (np. 1.234,56)
    if (str.includes(",") && str.includes(".")) {
        // Usuwamy kropki i zamieniamy przecinek na kropkę
      str = str.replace(/\./g, "").replace(",", ".");
    } else {
        // Jeśli jest tylko przecinek, zamieniamy go na kropkę
      str = str.replace(",", ".");
    }
    
    const result = parseFloat(str);
    return isNaN(result) ? 0 : result;
}

function updateProductsTable(data) {
    if (!data || data.length < 2) {
        console.log("Brak danych do wyświetlenia");
        return;
    }

    const table = document.getElementById("products-table");
    const thead = table.querySelector("thead");
    const tbody = document.getElementById("products-table-body");
    const deliveryDate = document.getElementById("delivery_date").value;
    const currency = document.getElementById("currency").value;
    const exchangeRate = currency === "EUR" ? document.getElementById("exchange_rate").value : "NaN";
    
    // Aktualizacja nagłówków
    const headers = data[0];
    console.log("Znalezione nagłówki:", headers);
    thead.innerHTML = `
        <tr>
            <th scope="col" class="px-4 py-3 text-purple-700 dark:text-purple-300">Lp.</th>
            ${headers
              .map(
                (header) => `
                <th scope="col" class="px-4 py-3 text-purple-700 dark:text-purple-300">${header}</th>
            `
              )
              .join("")}
            <th scope="col" class="px-4 py-3 text-purple-700 dark:text-purple-300">Kurs EUR</th>
            <th scope="col" class="px-4 py-3 text-purple-700 dark:text-purple-300">Data dostawy</th>
        </tr>
    `;

    // Aktualizacja danych
    const rows = data.slice(1);
    tbody.innerHTML = rows
      .map(
        (row, index) => `
        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-violet-50 dark:hover:bg-violet-900">
            <td class="px-4 py-3">${index + 1}</td>
            ${row
              .map(
                (cell) => `
                <td class="px-4 py-3 break-words">${cell || "0"}</td>
            `
              )
              .join("")}
            <td class="px-4 py-3 break-words">${exchangeRate}</td>
            <td class="px-4 py-3 break-words">${deliveryDate || ""}</td>
        </tr>
    `
      )
      .join("");

    // Aktualizacja liczników
    document.getElementById("items_count").textContent = rows.length;
    document.getElementById("products_count").textContent = rows.length;

    // Szukaj numerów lotów i palet w danych oraz obliczaj wartość
    let lots = new Set();
    let pallets = new Set();
    let totalValue = 0;

    rows.forEach((row, rowIndex) => {
        console.log(`\nAnalizuję wiersz ${rowIndex + 1}:`);
        const rowData = {};
        headers.forEach((header, idx) => {
            const headerLower = header.toLowerCase();
            rowData[headerLower] = row[idx] || "0";
            console.log(`  ${headerLower}: ${row[idx] || "0"}`);
            
            // Szukamy kolumny z wartością
            if (headerLower.includes('wartość') || headerLower.includes('wartosc') || 
                headerLower.includes('value') || headerLower.includes('cena') || 
                headerLower.includes('price')) {
                const value = parseNumber(row[idx]);
                console.log(`  Znaleziono wartość: ${value}`);
                totalValue += value;
            }
        });

        // Szukaj numerów lotów i palet
        Object.entries(rowData).forEach(([key, value]) => {
            if (value && value !== "0") {
                if (key.includes('lot') || key.includes('batch')) {
                    lots.add(value);
                    console.log(`  Znaleziono numer lotu: ${value}`);
                }
                if (key.includes('palet') || key.includes('pallet')) {
                    pallets.add(value);
                    console.log(`  Znaleziono numer palety: ${value}`);
                }
            }
        });
    });

    // Aktualizacja pól lotów i palet
    if (lots.size > 0) {
        document.getElementById("summary_lot_number").value = Array.from(lots).join(", ");
        document.getElementById("lots_count").textContent = lots.size;
    } else {
        document.getElementById("summary_lot_number").value = "";
        document.getElementById("lots_count").textContent = "0";
    }

    if (pallets.size > 0) {
        document.getElementById("summary_pallet_number").value = Array.from(pallets).join(", ");
        document.getElementById("pallets_count").textContent = pallets.size;
    } else {
        document.getElementById("summary_pallet_number").value = "";
        document.getElementById("pallets_count").textContent = "0";
    }

    // Aktualizacja łącznej wartości
    const selectedCurrency = document.getElementById("currency").value || "PLN";
    console.log(`Łączna wartość przed formatowaniem: ${totalValue}`);
    const formattedValue = new Intl.NumberFormat("pl-PL", {
        style: "currency",
        currency: selectedCurrency,
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
    }).format(totalValue);
    console.log(`Sformatowana łączna wartość: ${formattedValue}`);
    document.getElementById("total_value").textContent = formattedValue;
  }

  // Funkcja pokazująca pop-up
  function showMissingDataPopup(missingFields) {
    const popup = document.getElementById("missing_data_popup");
    const missingDataList = document.getElementById("missing_data_list");
    
    // Wyczyść listę
    missingDataList.innerHTML = "";
    
    // Dodaj brakujące pola do listy
    missingFields.forEach(field => {
        const li = document.createElement("li");
        li.textContent = field;
        missingDataList.appendChild(li);
    });
    
    // Pokaż pop-up
    popup.classList.remove("invisible", "opacity-0");
  }

  function hideMissingDataPopup() {
    const popup = document.getElementById("missing_data_popup");
    popup.classList.add("invisible", "opacity-0");
  }

  // Obsługa pop-upu
  function initializePopup() {
    console.log("Inicjalizacja pop-upu");
    const popup = document.getElementById("missing_data_popup");
    const confirmButton = document.getElementById("confirm_missing_data");
    const closeButton = document.getElementById("close_missing_data");

    confirmButton?.addEventListener("click", function() {
      const lotNumber = document.getElementById("popup_lot_number").value;
      const palletNumber = document.getElementById("popup_pallet_number").value;

      if (lotNumber) {
        document.getElementById("summary_lot_number").value = lotNumber;
        document.getElementById("lots_count").textContent = "1";
      }
      if (palletNumber) {
        document.getElementById("summary_pallet_number").value = palletNumber;
        document.getElementById("pallets_count").textContent = "1";
      }

      // Aktualizacja tabeli produktów
      const table = document.getElementById("products-table");
      const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.toLowerCase());
      const tbody = document.getElementById("products-table-body");
      const rows = tbody.querySelectorAll("tr");

      // Znajdź indeksy kolumn LOT i Pallet
      let lotColumnIndex = headers.findIndex(h => h.includes('lot') || h.includes('batch'));
      let palletColumnIndex = headers.findIndex(h => h.includes('palet') || h.includes('pallet'));

      // Jeśli kolumny nie istnieją, dodaj je
      if (lotColumnIndex === -1 && lotNumber) {
        // Dodaj kolumnę LOT
        const headerRow = table.querySelector("thead tr");
        const lotHeader = document.createElement("th");
        lotHeader.textContent = "Numer LOT";
        lotHeader.className = "px-4 py-3 text-purple-700 dark:text-purple-300";
        headerRow.appendChild(lotHeader);
        lotColumnIndex = headers.length;
        headers.push("numer lot");
      }

      if (palletColumnIndex === -1 && palletNumber) {
        // Dodaj kolumnę Pallet
        const headerRow = table.querySelector("thead tr");
        const palletHeader = document.createElement("th");
        palletHeader.textContent = "Numer Palety";
        palletHeader.className = "px-4 py-3 text-purple-700 dark:text-purple-300";
        headerRow.appendChild(palletHeader);
        palletColumnIndex = headers.length;
        headers.push("numer palety");
      }

      // Aktualizuj lub dodaj wartości w wierszach
      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        
        if (lotNumber && lotColumnIndex !== -1) {
          if (cells[lotColumnIndex]) {
            cells[lotColumnIndex].textContent = lotNumber;
          } else {
            const lotCell = document.createElement("td");
            lotCell.textContent = lotNumber;
            lotCell.className = "px-4 py-3 break-words";
            row.appendChild(lotCell);
          }
        }
        
        if (palletNumber && palletColumnIndex !== -1) {
          if (cells[palletColumnIndex]) {
            cells[palletColumnIndex].textContent = palletNumber;
          } else {
            const palletCell = document.createElement("td");
            palletCell.textContent = palletNumber;
            palletCell.className = "px-4 py-3 break-words";
            row.appendChild(palletCell);
          }
        }
      });

      popup.classList.add("invisible", "opacity-0");
      // Przejdź do następnego kroku po uzupełnieniu danych
      currentStep = 3;
      showStep(3);
    });

    closeButton?.addEventListener("click", function() {
      popup.classList.add("invisible", "opacity-0");
    });

    popup?.addEventListener("click", function(e) {
      if (e.target === popup) {
        popup.classList.add("invisible", "opacity-0");
      }
    });
}

// Obsługa drag & drop oraz wyboru plików
function initializeFileUpload() {
    const dropzone = document.getElementById("dropzone-file");
    const dropzoneLabel = dropzone.parentElement;
    const fileList = document.getElementById("file-list");

    // Obsługa przeciągania plików
    dropzoneLabel.addEventListener("dragenter", (e) => {
        e.preventDefault();
        e.stopPropagation();
      dropzoneLabel.classList.add(
        "border-purple-500",
        "bg-violet-50",
        "dark:bg-violet-900"
      );
    });

    dropzoneLabel.addEventListener("dragleave", (e) => {
        e.preventDefault();
        e.stopPropagation();
      dropzoneLabel.classList.remove(
        "border-purple-500",
        "bg-violet-50",
        "dark:bg-violet-900"
      );
    });

    dropzoneLabel.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    dropzoneLabel.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
      dropzoneLabel.classList.remove(
        "border-purple-500",
        "bg-violet-50",
        "dark:bg-violet-900"
      );
        
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    });

    // Obsługa wyboru plików przez input
    dropzone.addEventListener("change", (e) => {
        handleFiles(e.target.files);
    });
}

// Funkcja obsługująca dodane pliki
function handleFiles(files) {
    const fileList = document.getElementById("file-list");
    
    Array.from(files).forEach((file) => {
        // Sprawdzenie rozmiaru pliku
      if (file.size > 10 * 1024 * 1024) {
        alert("Plik jest zbyt duży. Maksymalny rozmiar to 10MB.");
            return;
        }

        // Sprawdzenie rozszerzenia pliku
      const extension = file.name.split(".").pop().toLowerCase();
      const allowedExtensions = ["pdf", "doc", "docx", "xls", "xlsx", "csv"];
        if (!allowedExtensions.includes(extension)) {
        alert(
          "Niedozwolony format pliku. Dozwolone formaty to: PDF, DOC, DOCX, XLS, XLSX, CSV"
        );
            return;
        }

        // Dodanie pliku do listy
      const tr = document.createElement("tr");
      tr.className = "bg-white border-b dark:bg-gray-800 dark:border-gray-700";
        tr.innerHTML = `
            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                ${file.name}
            </td>
            <td class="px-6 py-4">
                ${formatFileSize(file.size)}
            </td>
            <td class="px-6 py-4">
                ${getFileTypeDisplay(file)}
            </td>
            <td class="px-6 py-4 text-center">
                ${getStatusBadge(file)}
            </td>
            <td class="px-6 py-4">
                <button type="button" class="font-medium text-red-600 dark:text-red-500 hover:underline">
                    Usuń
                </button>
            </td>
        `;

        // Dodanie obsługi usuwania pliku
      const deleteButton = tr.querySelector("button");
      deleteButton.addEventListener("click", () => {
            tr.remove();
            updateSummary();
        });

        fileList.appendChild(tr);

        // Jeśli to plik Excel lub CSV, przetwórz jego zawartość
      if (["xlsx", "xls", "csv"].includes(extension)) {
            const reader = new FileReader();
        reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false,
                        defval: "",
              header: 1,
                    });
                    
                    if (jsonData.length > 0) {
                        updateProductsTable(jsonData);
                    }
                } catch (error) {
            console.error("Błąd podczas przetwarzania pliku:", error);
            alert(
              "Wystąpił błąd podczas przetwarzania pliku. Sprawdź format pliku."
            );
                }
            };
            reader.readAsArrayBuffer(file);
        }
    });

    // Aktualizacja podsumowania
    updateSummary();
}

function getFileTypeDisplay(file) {
    const extension = file.name.split(".").pop().toLowerCase();
    const typeMap = {
      pdf: "PDF",
      doc: "Word (DOC)",
      docx: "Word (DOCX)",
      xls: "Excel (XLS)",
      xlsx: "Excel (XLSX)",
      csv: "CSV",
    };
    return typeMap[extension] || "Nieznany";
}

function getStatusBadge(file) {
    return `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">
        OK
    </span>`;
}

  // Obsługa suwaka procentowego
  function initializePercentageSlider() {
    const valuePercentage = document.getElementById("value_percentage");
    const valuePercentageDisplay = document.getElementById("value_percentage_display");

    if (valuePercentage && valuePercentageDisplay) {
      valuePercentage.addEventListener("input", function(e) {
        const value = e.target.value;
        valuePercentageDisplay.textContent = value;

        // Aktualizacja wartości w podsumowaniu
        const summaryValuePercentage = document.getElementById("summary_value_percentage");
        if (summaryValuePercentage) {
          summaryValuePercentage.value = value + "%";
        }
      });
    }
  }

  // Jeden wspólny nasłuchiwacz DOMContentLoaded
  document.addEventListener("DOMContentLoaded", function() {
    console.log("DOM Content Loaded - inicjalizacja wszystkich komponentów");
    
    // Inicjalizacja wszystkich komponentów
    initializeFileUpload();
    initializePopup();
    initializePercentageSlider();
    
    // Obsługa suwaka procentowego
    const valuePercentage = document.getElementById("value_percentage");
    const valuePercentageDisplay = document.getElementById("value_percentage_display");
    
    valuePercentage?.addEventListener("input", function (e) {
        const value = e.target.value;
        if (valuePercentageDisplay) {
            valuePercentageDisplay.textContent = value;
        }
        
        // Aktualizacja wartości w podsumowaniu
      const summaryValuePercentage = document.getElementById(
        "summary_value_percentage"
      );
        if (summaryValuePercentage) {
        summaryValuePercentage.value = value + "%";
        }
    });
    
    // Przyciski "Dalej"
    document
      .getElementById("step1NextButton")
      ?.addEventListener("click", () => nextStep(2));
    document
      .getElementById("step2NextButton")
      ?.addEventListener("click", () => nextStep(3));
    document
      .getElementById("step3NextButton")
      ?.addEventListener("click", () => nextStep(4));
    
    // Przyciski "Wstecz"
    document
      .getElementById("step2PrevButton")
      ?.addEventListener("click", () => prevStep(1));
    document
      .getElementById("step3PrevButton")
      ?.addEventListener("click", () => prevStep(2));
    document
      .getElementById("step4PrevButton")
      ?.addEventListener("click", () => prevStep(3));
    
    // Obsługa zmiany kategorii
    const categorySelect = document.getElementById("delivery_category");
    if (categorySelect) {
      console.log("Dodaję listener dla kategorii");
      categorySelect.addEventListener("change", toggleOtherCategory);
    }
    
    // Obsługa zmiany waluty
    const currencySelect = document.getElementById("currency");
    if (currencySelect) {
      console.log("Dodaję listener dla waluty");
      currencySelect.addEventListener("change", toggleExchangeRate);
    }
    
    // Obsługa zmiany stawki VAT
    const vatRadios = document.querySelectorAll('input[name="vat_rate"]');
    vatRadios.forEach((radio) => {
      console.log("Dodaję listener dla VAT:", radio.value);
      radio.addEventListener("change", togglePriceType);
    });
    
    // Inicjalne wywołanie funkcji
    toggleOtherCategory();
    toggleExchangeRate();
    togglePriceType();
    
    // Inicjalne pokazanie pierwszego kroku
    showStep(1);
});
</script>

<style>
    .shadow-soft {
        --tw-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    --tw-shadow-colored: 0 1px 3px 0 var(--tw-shadow-color),
      0 1px 2px -1px var(--tw-shadow-color);
    box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000),
      var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
    }
</style>
{% endblock %}
